<!DOCTYPE html>
    <html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Pour dl un fichier (j'espère)</title>
        <link rel="stylesheet" href="/static/design_dl.css">
    </head>
    <body>
        <h1>Téléchargement de votre fichier</h1>
        <div id="downloadForm">
            <input type="password" name="password" placeholder="Entrez le mot de passe" id="mdp">
            <button type="button" id="downloadButton">Télécharger</button>
        </div>
        <div id="dlResponse" class="message"></div>
        <script>
            async function deriveKey(password, salt) {
                // Dérivation de clé PBKDF2
                const enc = new TextEncoder();
                const keyMaterial = await window.crypto.subtle.importKey(
                    'raw',
                    enc.encode(password),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveBits', 'deriveKey']
                );

                return await window.crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    true,
                    ['encrypt', 'decrypt']
                );
            }
            async function decryptFile(encryptedBlob, password) {
                // Lire le sel et l'IV depuis le début du fichier
                const arrayBuffer = await encryptedBlob.arrayBuffer();
                const salt = new Uint8Array(arrayBuffer.slice(0, 16));
                console.log('salt', salt);
                const iv = new Uint8Array(arrayBuffer.slice(16, 28));
                console.log('iv', iv);
                const encryptedContent = new Uint8Array(arrayBuffer.slice(28));
                console.log('Deriving key');
                // Dérivation de la clé
                const key = await deriveKey(password, salt);
                console.log('Déchiffrement...');
                // Déchiffrement
                const decryptedContent = await window.crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    encryptedContent
                );
                console.log('Déchiffré !');
                return new Blob([decryptedContent], { type: 'application/octet-stream' });
            }

            async function downloadFile() {
                const formData = new FormData();
                const passwordInput = document.getElementById("mdp");
                const filePath = window.location.href.split('/downloadfilelink/', 2)[1].split('/', 1)[0];

                if(!passwordInput.value) {
                    document.getElementById("dlResponse").innerText = "Veuillez entrer un mot de passe.";
                    return;
                }

                formData.append("token", filePath);

                try {
                    console.log(filePath);
                    const response = await fetch("/downloadfilelink/", {
                        method: "POST",
                        body: formData,
                    });
                    console.log(response.ok);
                    if(response.ok && response.headers.get('Content-Type') === 'application/octet-stream') {
                        const contentDispositionHeader = response.headers.get('Content-Disposition');
                        const utf8FilenameRegex = /filename\*=UTF-8''([\w%\-\.]+)(?:; ?|$)/i;
                        const asciiFilenameRegex = /^filename=(["']?)(.*?[^\\])\1(?:; ?|$)/i;

                        let fileName = null;
                        if (utf8FilenameRegex.test(contentDispositionHeader)) {
                            fileName = decodeURIComponent(utf8FilenameRegex.exec(contentDispositionHeader)[1]);
                        } else {
                            const filenameStart = contentDispositionHeader.toLowerCase().indexOf('filename=');
                            if (filenameStart >= 0) {
                                const partialDisposition = contentDispositionHeader.slice(filenameStart);
                                const matches = asciiFilenameRegex.exec(partialDisposition);
                                if (matches != null && matches[2]) {
                                    fileName = matches[2];
                                }
                            }
                        }

                        const blob = await response.blob();
                        // Déchiffrement du fichier
                        console.log('Décryptage...')
                        const decryptedBlob = await decryptFile(blob, passwordInput.value);
                        const blobUrl = window.URL.createObjectURL(decryptedBlob);
                        console.log('Fichier décypté')

                        const link = document.createElement('a');
                        link.href = blobUrl;
                        link.setAttribute('download', `${fileName}`);
                        document.body.appendChild(link);
                        link.click();
                        link.parentNode.removeChild(link);

                        window.URL.revokeObjectURL(blobUrl);
                        passwordInput.value = '';
                        document.getElementById("dlResponse").innerText = `Fichier téléchargé`;
                    } else {
                        const responseData = await response.json();
                        document.getElementById("dlResponse").innerText = `${responseData.Info} : ${responseData.Error.detail ?? responseData.Error}`;
                    }
                } catch (err) {
                    console.log(err)
                    document.getElementById("dlResponse").innerText = `Erreur de déchiffrement`;
                }
            }
            document.getElementById("mdp").addEventListener("keydown", async (e) => {
                if (e.code === "Enter") {  //checks whether the pressed key is "Enter"
                    await downloadFile();
                }
            });
            document.getElementById("downloadButton").addEventListener("click", async () => {
                await downloadFile();
            });
        </script>
    </body>
    </html>